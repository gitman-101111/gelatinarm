<ResourceDictionary
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:Gelatinarm.Controls"
    xmlns:converters="using:Gelatinarm.Converters.Visibility"
    xmlns:textConverters="using:Gelatinarm.Converters.Text"
    xmlns:imageConverters="using:Gelatinarm.Converters.Image"
    xmlns:mediaConverters="using:Gelatinarm.Converters">

    <!-- Converters -->
    <converters:VisibilityConverter x:Key="BoolToVisibility" ConversionType="Boolean" />
    <converters:VisibilityConverter x:Key="InverseBoolToVisibility" ConversionType="Inverse" />
    <textConverters:RuntimeTicksConverter x:Key="RuntimeConverter" />
    <converters:VisibilityConverter x:Key="EmptyStringToVisibility" ConversionType="EmptyString" />
    <converters:VisibilityConverter x:Key="ProgressVisibilityConverter" ConversionType="ProgressBar" />
    <converters:VisibilityConverter x:Key="NullToVisibilityConverter" ConversionType="Nullable" />
    <converters:VisibilityConverter x:Key="CountToVisibilityConverter" ConversionType="PositiveInt" />
    <textConverters:MediaTextConverter x:Key="DateConverter" ConversionType="Date" />
    <textConverters:MediaTextConverter x:Key="VideoQualityConverter" ConversionType="VideoQuality" />
    <imageConverters:PersonImageConverter x:Key="PersonImageConverter" />
    <imageConverters:ImageConverter x:Key="ImageConverter" />
    <mediaConverters:FavoriteIconConverter x:Key="FavoriteIconConverter" />

    <!-- Common Layout Components -->

    <!-- Base Details Page Layout Template -->
    <ControlTemplate x:Key="DetailsPageTemplate" TargetType="ContentControl">
        <Grid>
            <!-- Backdrop Image - Full Screen Background -->
            <Image x:Name="BackdropImage"
                   Source="{Binding BackdropImage}"
                   Stretch="UniformToFill"
                   VerticalAlignment="Stretch"
                   HorizontalAlignment="Stretch" />

            <!-- Dark overlay for better text readability -->
            <Grid Background="#DD000000" />

            <!-- Content Presenter for page-specific content -->
            <ContentPresenter />

            <!-- Loading Overlay -->
            <controls:LoadingOverlay x:Name="LoadingOverlay"
                                     IsLoading="{Binding IsLoading}"
                                     LoadingText="Loading details..." />
        </Grid>
    </ControlTemplate>

    <!-- Standard Details ListView Style -->
    <Style x:Key="DetailsListViewStyle" TargetType="ListView">
        <Setter Property="SelectionMode" Value="None" />
        <Setter Property="IsItemClickEnabled" Value="False" />
        <Setter Property="IsTabStop" Value="False" />
        <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto" />
        <Setter Property="ScrollViewer.VerticalScrollMode" Value="Auto" />
        <Setter Property="ScrollViewer.HorizontalScrollMode" Value="Disabled" />
        <Setter Property="ScrollViewer.IsVerticalRailEnabled" Value="True" />
        <Setter Property="ScrollViewer.BringIntoViewOnFocusChange" Value="False" />
        <Setter Property="TabNavigation" Value="Once" />
        <Setter Property="ItemContainerStyle">
            <Setter.Value>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="Margin" Value="0" />
                    <Setter Property="IsTabStop" Value="False" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListViewItem">
                                <ContentPresenter HorizontalAlignment="Stretch"
                                                  VerticalAlignment="Top" />
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- Progress Bar Template -->
    <DataTemplate x:Key="ProgressBarTemplate">
        <Grid Height="4"
              Margin="{StaticResource StandardControlMargin}"
              MaxWidth="500"
              Visibility="{Binding ShowProgress, Converter={StaticResource BoolToVisibility}}">
            <Rectangle Fill="#33FFFFFF" />
            <Rectangle HorizontalAlignment="Left"
                       Fill="{StaticResource AppAccentBrush}"
                       Width="{Binding ProgressWidth}" />
        </Grid>
    </DataTemplate>

    <!-- Progress Text Template -->
    <DataTemplate x:Key="ProgressTextTemplate">
        <TextBlock Text="{Binding ProgressText}"
                   FontSize="12"
                   Foreground="LightGray"
                   HorizontalAlignment="Center"
                   Visibility="{Binding ShowProgress, Converter={StaticResource BoolToVisibility}}" />
    </DataTemplate>

    <!-- Common Styles -->
    <Style x:Key="DetailPageTitleStyle" TargetType="TextBlock">
        <Setter Property="FontSize" Value="32" />
        <Setter Property="FontWeight" Value="SemiBold" />
        <Setter Property="TextWrapping" Value="Wrap" />
        <Setter Property="Margin" Value="0,0,0,12" />
    </Style>

    <Style x:Key="DetailPageOverviewStyle" TargetType="TextBlock">
        <Setter Property="FontSize" Value="14" />
        <Setter Property="TextWrapping" Value="Wrap" />
        <Setter Property="Opacity" Value="0.8" />
        <Setter Property="MaxWidth" Value="800" />
    </Style>

    <Style x:Key="MetadataTextStyle" TargetType="TextBlock">
        <Setter Property="FontSize" Value="13" />
        <Setter Property="Opacity" Value="0.7" />
        <Setter Property="Margin" Value="0,0,16,0" />
    </Style>

    <!-- Cast Member Template -->
    <DataTemplate x:Key="CastMemberTemplate">
        <Grid Width="120">
            <Grid.RowDefinitions>
                <RowDefinition Height="120" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Person Image -->
            <Ellipse
                Grid.Row="0"
                Width="120"
                Height="120"
                HorizontalAlignment="Center">
                <Ellipse.Fill>
                    <ImageBrush
                        ImageSource="{Binding Converter={StaticResource PersonImageConverter}}"
                        Stretch="UniformToFill" />
                </Ellipse.Fill>
            </Ellipse>

            <!-- Person Name -->
            <TextBlock
                Grid.Row="1"
                Text="{Binding Name}"
                FontSize="13"
                FontWeight="SemiBold"
                TextTrimming="CharacterEllipsis"
                HorizontalAlignment="Center"
                Margin="0,8,0,2" />

            <!-- Character Name -->
            <TextBlock
                Grid.Row="2"
                Text="{Binding Role}"
                FontSize="12"
                Opacity="0.7"
                TextTrimming="CharacterEllipsis"
                HorizontalAlignment="Center"
                Visibility="{Binding Role, Converter={StaticResource EmptyStringToVisibility}}" />
        </Grid>
    </DataTemplate>

    <!-- Episode Item Template -->
    <DataTemplate x:Key="EpisodeItemTemplate">
        <Grid Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="160" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Thumbnail -->
            <Grid Grid.Column="0" Margin="0,0,16,0">
                <Border Height="90" CornerRadius="4">
                    <Border.Background>
                        <ImageBrush ImageSource="{Binding Converter={StaticResource ImageConverter}}"
                                    Stretch="UniformToFill" />
                    </Border.Background>
                </Border>

                <!-- Progress Bar -->
                <ProgressBar
                    VerticalAlignment="Bottom"
                    Value="{Binding UserData.PlayedPercentage}"
                    Visibility="{Binding UserData.PlayedPercentage, Converter={StaticResource ProgressVisibilityConverter}}" />
            </Grid>

            <!-- Episode Info -->
            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                <TextBlock
                    Text="{Binding Name}"
                    FontSize="16"
                    FontWeight="SemiBold"
                    TextTrimming="CharacterEllipsis" />

                <TextBlock
                    Text="{Binding Overview}"
                    FontSize="13"
                    Opacity="0.7"
                    TextTrimming="CharacterEllipsis"
                    MaxLines="2"
                    Margin="0,4,0,0" />

                <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                    <TextBlock
                        Text="{Binding RunTimeTicks, Converter={StaticResource RuntimeConverter}}"
                        Style="{StaticResource MetadataTextStyle}" />

                    <TextBlock
                        Text="{Binding PremiereDate, Converter={StaticResource DateConverter}}"
                        Style="{StaticResource MetadataTextStyle}" />
                </StackPanel>
            </StackPanel>

            <!-- Play Button -->
            <Button
                Grid.Column="2"
                Style="{StaticResource TransparentButtonStyle}"
                Margin="16,0,0,0">
                <FontIcon Glyph="&#xE768;" FontSize="20" />
            </Button>
        </Grid>
    </DataTemplate>

    <!-- Similar Item Template -->
    <DataTemplate x:Key="SimilarItemTemplate">
        <Grid Width="150" Height="225" Margin="0,0,12,12">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Poster Image -->
            <Border Grid.Row="0" Background="{ThemeResource SystemControlBackgroundChromeMediumBrush}">
                <Image Source="{Binding Converter={StaticResource ImageConverter}}"
                       Stretch="UniformToFill" />
            </Border>

            <!-- Progress Bar -->
            <ProgressBar Grid.Row="0"
                         VerticalAlignment="Bottom"
                         Value="{Binding UserData.PlayedPercentage}"
                         Visibility="{Binding UserData.PlayedPercentage, Converter={StaticResource ProgressVisibilityConverter}}" />

            <!-- Title -->
            <StackPanel Grid.Row="1" Padding="4">
                <TextBlock Text="{Binding Name}"
                           FontSize="14"
                           TextTrimming="CharacterEllipsis" />
                <TextBlock Text="{Binding ProductionYear}"
                           FontSize="12"
                           Opacity="0.7"
                           Visibility="{Binding ProductionYear, Converter={StaticResource NullToVisibilityConverter}}" />
            </StackPanel>
        </Grid>
    </DataTemplate>

    <!-- Media Info Panel Template -->
    <DataTemplate x:Key="MediaInfoTemplate">
        <StackPanel Orientation="Horizontal" Spacing="16">
            <!-- Year -->
            <TextBlock
                Text="{Binding ProductionYear}"
                Style="{StaticResource MetadataTextStyle}"
                Visibility="{Binding ProductionYear, Converter={StaticResource NullToVisibilityConverter}}" />

            <!-- Runtime -->
            <TextBlock
                Text="{Binding RunTimeTicks, Converter={StaticResource RuntimeConverter}}"
                Style="{StaticResource MetadataTextStyle}"
                Visibility="{Binding RunTimeTicks, Converter={StaticResource NullToVisibilityConverter}}" />

            <!-- Rating -->
            <TextBlock
                Text="{Binding OfficialRating}"
                Style="{StaticResource MetadataTextStyle}"
                Visibility="{Binding OfficialRating, Converter={StaticResource EmptyStringToVisibility}}" />

            <!-- Video Quality -->
            <TextBlock
                Text="{Binding MediaStreams, Converter={StaticResource VideoQualityConverter}}"
                Style="{StaticResource MetadataTextStyle}"
                FontWeight="SemiBold"
                Foreground="{ThemeResource AccentButtonBackground}" />
        </StackPanel>
    </DataTemplate>

    <!-- Genres List Template -->
    <DataTemplate x:Key="GenresTemplate">
        <ItemsControl ItemsSource="{Binding Genres}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal" Spacing="8" />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Button
                        Content="{Binding}"
                        Style="{StaticResource StandardButtonStyle}" />
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
    </DataTemplate>

    <!-- Action Buttons Template (Enhanced) -->
    <DataTemplate x:Key="ActionButtonsTemplate">
        <StackPanel Orientation="Horizontal" Spacing="12">
            <!-- Play/Resume Button (shows one or the other) -->
            <Button
                Command="{Binding PlayCommand}"
                Visibility="{Binding CanResume, Converter={StaticResource InverseBoolToVisibility}}"
                Style="{StaticResource PrimaryButtonStyle}"
                MinWidth="100"
                MinHeight="36"
                IsTabStop="True">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <SymbolIcon Symbol="Play" />
                    <TextBlock Text="{Binding PlayButtonText}" FontSize="14" Margin="8,0,0,0" />
                </StackPanel>
            </Button>

            <Button
                Command="{Binding ResumeCommand}"
                Visibility="{Binding CanResume, Converter={StaticResource BoolToVisibility}}"
                Style="{StaticResource PrimaryButtonStyle}"
                MinWidth="100"
                MinHeight="36"
                IsTabStop="True">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <SymbolIcon Symbol="Play" />
                    <TextBlock Text="{Binding ResumeButtonText}" FontSize="14" Margin="8,0,0,0" />
                </StackPanel>
            </Button>

            <!-- Restart Button (shown when can resume) -->
            <Button
                Margin="{StaticResource StandardControlMargin}"
                Style="{StaticResource SecondaryButtonStyle}"
                Command="{Binding RestartCommand}"
                MinWidth="80"
                MinHeight="36"
                Visibility="{Binding CanResume, Converter={StaticResource BoolToVisibility}}">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <SymbolIcon Symbol="Refresh" />
                    <TextBlock Text="Restart" FontSize="14" Margin="8,0,0,0" />
                </StackPanel>
            </Button>

            <!-- Favorite Button -->
            <ToggleButton
                x:Name="FavoriteButton"
                Margin="{StaticResource StandardControlMargin}"
                Style="{StaticResource TransparentToggleButtonStyle}"
                IsChecked="{Binding IsFavorite, Mode=TwoWay}"
                Command="{Binding ToggleFavoriteCommand}"
                MinWidth="80"
                MinHeight="36"
                HorizontalContentAlignment="Center"
                VerticalContentAlignment="Center">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <FontIcon Glyph="{Binding IsFavorite, Converter={StaticResource FavoriteIconConverter}}"
                              FontSize="16" />
                    <TextBlock Text="Favorite" FontSize="14" Margin="8,0,0,0" />
                </StackPanel>
            </ToggleButton>

            <!-- Watched Button -->
            <ToggleButton
                x:Name="WatchedButton"
                Margin="{StaticResource StandardControlMargin}"
                Style="{StaticResource TransparentToggleButtonStyle}"
                IsChecked="{Binding IsWatched, Mode=TwoWay}"
                Command="{Binding ToggleWatchedCommand}"
                MinWidth="110"
                MinHeight="36"
                HorizontalContentAlignment="Center"
                VerticalContentAlignment="Center"
                Padding="12,8">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <SymbolIcon Symbol="Accept" />
                    <TextBlock Text="{Binding WatchedButtonText}" FontSize="14" Margin="8,0,0,0" />
                </StackPanel>
            </ToggleButton>

            <!-- More Options -->
            <Button Style="{StaticResource TransparentButtonStyle}"
                    MinWidth="36"
                    MinHeight="36">
                <FontIcon Glyph="&#xE712;" FontSize="20" />
                <Button.Flyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="Add to Playlist" Icon="Add" />
                        <MenuFlyoutItem Text="Download" Icon="Download" />
                        <MenuFlyoutSeparator />
                        <MenuFlyoutItem Text="View in Web" Icon="Globe" />
                    </MenuFlyout>
                </Button.Flyout>
            </Button>
        </StackPanel>
    </DataTemplate>

</ResourceDictionary>
