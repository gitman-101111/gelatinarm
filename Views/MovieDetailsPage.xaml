<?xml version="1.0" encoding="utf-8"?>

<views:DetailsPage
    x:Class="Gelatinarm.Views.MovieDetailsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:views="using:Gelatinarm.Views"
    xmlns:controls="using:Gelatinarm.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{StaticResource ApplicationPageBackgroundThemeBrush}"
    NavigationCacheMode="Disabled">

    <Page.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="ms-appx:///Views/DetailsPage.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Page.Resources>

    <Grid>
        <!-- Backdrop Image - Full Screen Background -->
        <Image x:Name="BackdropImage"
               Source="{x:Bind ViewModel.BackdropImage, Mode=OneWay}"
               Stretch="UniformToFill"
               VerticalAlignment="Stretch"
               HorizontalAlignment="Stretch" />

        <!-- Dark overlay for better text readability -->
        <Grid Background="#DD000000" />

        <!-- Scrollable Content -->
        <ListView x:Name="ContentScrollViewer"
                  SelectionMode="None"
                  IsItemClickEnabled="False"
                  IsTabStop="False"
                  ScrollViewer.VerticalScrollBarVisibility="Auto"
                  ScrollViewer.VerticalScrollMode="Auto"
                  ScrollViewer.HorizontalScrollMode="Disabled"
                  ScrollViewer.IsVerticalRailEnabled="True"
                  ScrollViewer.BringIntoViewOnFocusChange="False"
                  TabNavigation="Once">
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="Margin" Value="0" />
                    <Setter Property="IsTabStop" Value="False" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListViewItem">
                                <ContentPresenter HorizontalAlignment="Stretch"
                                                  VerticalAlignment="Top" />
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListView.ItemContainerStyle>

            <!-- Hero Section -->
            <Grid Padding="{StaticResource SafeAreaPadding}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- Poster -->
                    <Border Width="200"
                            Height="300"
                            CornerRadius="2"
                            Margin="{StaticResource SafeAreaPadding}">
                        <Grid>
                            <Image Source="{x:Bind ViewModel.PrimaryImage, Mode=OneWay}"
                                   Stretch="UniformToFill" />

                            <!-- Progress Bar Overlay -->
                            <Grid VerticalAlignment="Bottom"
                                  HorizontalAlignment="Stretch"
                                  Visibility="{x:Bind ViewModel.HasProgress, Mode=OneWay, Converter={StaticResource BoolToVisibility}}">
                                <!-- Progress bar background -->
                                <Rectangle Height="6"
                                           Fill="#66000000"
                                           VerticalAlignment="Bottom" />
                                <!-- Progress bar -->
                                <Rectangle Height="6"
                                           Fill="{StaticResource SystemControlHighlightAccentBrush}"
                                           HorizontalAlignment="Left"
                                           VerticalAlignment="Bottom"
                                           Width="{x:Bind ViewModel.PlayedPercentage, Mode=OneWay, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=200}" />
                            </Grid>
                        </Grid>
                    </Border>

                    <!-- Info -->
                    <StackPanel Grid.Column="1"
                                VerticalAlignment="Top"
                                Margin="{StaticResource HeaderMargin}">
                        <TextBlock Text="{x:Bind ViewModel.Title, Mode=OneWay}"
                                   FontSize="32"
                                   FontWeight="SemiBold"
                                   TextWrapping="Wrap"
                                   Margin="0,0,0,8"
                                   Foreground="White" />

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="{x:Bind ViewModel.Year, Mode=OneWay}"
                                       FontSize="14"
                                       Foreground="LightGray" />
                            <TextBlock Text="•"
                                       FontSize="14"
                                       Foreground="LightGray"
                                       Visibility="{x:Bind ViewModel.Year, Mode=OneWay, Converter={StaticResource EmptyStringToVisibility}}" />
                            <TextBlock Text="{x:Bind ViewModel.Runtime, Mode=OneWay}"
                                       FontSize="14"
                                       Foreground="LightGray" />
                            <TextBlock Text="•"
                                       FontSize="14"
                                       Foreground="LightGray"
                                       Visibility="{x:Bind ViewModel.Runtime, Mode=OneWay, Converter={StaticResource EmptyStringToVisibility}}" />
                            <TextBlock Text="{x:Bind ViewModel.Rating, Mode=OneWay}"
                                       FontSize="14"
                                       Foreground="LightGray" />
                            <TextBlock Text="•"
                                       FontSize="14"
                                       Foreground="LightGray"
                                       Visibility="{x:Bind ViewModel.Rating, Mode=OneWay, Converter={StaticResource EmptyStringToVisibility}}" />
                            <TextBlock Text="{x:Bind ViewModel.GenresText, Mode=OneWay}"
                                       FontSize="14"
                                       Foreground="LightGray" />
                        </StackPanel>

                        <!-- Star Rating -->
                        <StackPanel Orientation="Horizontal"
                                    Margin="0,8,0,0"
                                    Visibility="{x:Bind ViewModel.CommunityRating, Mode=OneWay, Converter={StaticResource NullableToVisibilityConverter}}">
                            <SymbolIcon Symbol="SolidStar" Foreground="Gold" />
                            <TextBlock
                                Text="{x:Bind ViewModel.CommunityRating, Mode=OneWay, Converter={StaticResource MediaTextConverter}, ConverterParameter=Rating}"
                                FontSize="14"
                                Foreground="White"
                                Margin="4,0,0,0"
                                VerticalAlignment="Center" />
                            <TextBlock Text="/10"
                                       FontSize="14"
                                       Foreground="LightGray"
                                       Margin="2,0,0,0"
                                       VerticalAlignment="Center" />
                        </StackPanel>

                        <TextBlock Text="{x:Bind ViewModel.Overview, Mode=OneWay}"
                                   FontSize="14"
                                   LineHeight="20"
                                   Foreground="White"
                                   TextWrapping="Wrap"
                                   TextTrimming="WordEllipsis"
                                   MaxWidth="700"
                                   Height="80"
                                   Margin="{StaticResource HeaderMargin}" />

                        <!-- Director and Writers -->
                        <Grid Margin="0,16,0,0" MaxWidth="700">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="80" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!-- Director -->
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="Director:"
                                       FontWeight="SemiBold"
                                       Foreground="LightGray"
                                       Visibility="{x:Bind ViewModel.Director, Mode=OneWay, Converter={StaticResource EmptyStringToVisibility}}" />
                            <TextBlock Grid.Row="0" Grid.Column="1"
                                       Text="{x:Bind ViewModel.Director, Mode=OneWay}"
                                       Foreground="White"
                                       TextWrapping="Wrap"
                                       Visibility="{x:Bind ViewModel.Director, Mode=OneWay, Converter={StaticResource EmptyStringToVisibility}}" />

                            <!-- Writers -->
                            <TextBlock Grid.Row="1" Grid.Column="0"
                                       Text="Writers:"
                                       FontWeight="SemiBold"
                                       Foreground="LightGray"
                                       Margin="0,8,0,0"
                                       Visibility="{x:Bind ViewModel.Writers, Mode=OneWay, Converter={StaticResource EmptyStringToVisibility}}" />
                            <TextBlock Grid.Row="1" Grid.Column="1"
                                       Text="{x:Bind ViewModel.Writers, Mode=OneWay}"
                                       Foreground="White"
                                       TextWrapping="Wrap"
                                       Margin="0,8,0,0"
                                       Visibility="{x:Bind ViewModel.Writers, Mode=OneWay, Converter={StaticResource EmptyStringToVisibility}}" />
                        </Grid>

                        <!-- Playback Options -->
                        <StackPanel Margin="0,32,0,0">
                            <Grid MaxWidth="900">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <Grid.RowSpacing>2</Grid.RowSpacing>
                                <Grid.ColumnSpacing>12</Grid.ColumnSpacing>

                                <!-- Labels Row -->
                                <TextBlock Grid.Column="0" Grid.Row="0"
                                           Text="Version"
                                           FontSize="12"
                                           Foreground="LightGray"
                                           Margin="0,0,0,4" />
                                <TextBlock Grid.Column="1" Grid.Row="0"
                                           Text="Audio"
                                           FontSize="12"
                                           Foreground="LightGray"
                                           Margin="0,0,0,4" />
                                <TextBlock Grid.Column="2" Grid.Row="0"
                                           Text="Subtitles"
                                           FontSize="12"
                                           Foreground="LightGray"
                                           Margin="0,0,0,4" />

                                <!-- Dropdowns Row -->
                                <ComboBox x:Name="VersionComboBox"
                                          Grid.Column="0" Grid.Row="1"
                                          ItemsSource="{x:Bind ViewModel.AvailableVersions, Mode=OneWay}"
                                          SelectedItem="{x:Bind ViewModel.SelectedVersion, Mode=TwoWay}"
                                          DisplayMemberPath="Name"
                                          IsTabStop="True"
                                          HorizontalAlignment="Stretch"
                                          XYFocusDown="{Binding ElementName=PlayButton}" />
                                <ComboBox x:Name="AudioComboBox"
                                          Grid.Column="1" Grid.Row="1"
                                          ItemsSource="{x:Bind ViewModel.AvailableAudioTracks, Mode=OneWay}"
                                          SelectedItem="{x:Bind ViewModel.SelectedAudioTrack, Mode=TwoWay}"
                                          DisplayMemberPath="DisplayName"
                                          IsTabStop="True"
                                          HorizontalAlignment="Stretch"
                                          XYFocusDown="{Binding ElementName=PlayButton}" />
                                <ComboBox x:Name="SubtitleComboBox"
                                          Grid.Column="2" Grid.Row="1"
                                          ItemsSource="{x:Bind ViewModel.AvailableSubtitleTracks, Mode=OneWay}"
                                          SelectedItem="{x:Bind ViewModel.SelectedSubtitleTrack, Mode=TwoWay}"
                                          DisplayMemberPath="DisplayTitle"
                                          IsTabStop="True"
                                          HorizontalAlignment="Stretch"
                                          XYFocusDown="{Binding ElementName=PlayButton}" />
                            </Grid>
                        </StackPanel>

                        <!-- Action Buttons -->
                        <StackPanel Orientation="Horizontal"
                                    Margin="0,24,0,0"
                                    Spacing="8">
                            <Button x:Name="PlayButton"
                                    Style="{StaticResource PrimaryButtonStyle}"
                                    Command="{x:Bind ViewModel.PlayCommand}"
                                    MinWidth="100"
                                    MinHeight="36"
                                    IsTabStop="True"
                                    XYFocusUp="{Binding ElementName=VersionComboBox}"
                                    XYFocusDown="{Binding ElementName=CastListView}">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center"
                                            VerticalAlignment="Center">
                                    <SymbolIcon Symbol="Play" />
                                    <TextBlock Text="{x:Bind ViewModel.PlayButtonText, Mode=OneWay}" FontSize="14"
                                               Margin="8,0,0,0" />
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource SecondaryButtonStyle}"
                                    Command="{x:Bind ViewModel.RestartCommand}"
                                    MinWidth="100"
                                    MinHeight="36"
                                    IsTabStop="True"
                                    Visibility="{x:Bind ViewModel.CanResume, Mode=OneWay, Converter={StaticResource BoolToVisibility}}">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center"
                                            VerticalAlignment="Center">
                                    <SymbolIcon Symbol="Refresh" />
                                    <TextBlock Text="Restart" FontSize="14" Margin="8,0,0,0" />
                                </StackPanel>
                            </Button>
                            <Button x:Name="FavoriteButton"
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Command="{x:Bind ViewModel.ToggleFavoriteCommand}"
                                    MinWidth="100"
                                    MinHeight="36"
                                    IsTabStop="True"
                                    IsEnabled="True"
                                    Foreground="White">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center"
                                            VerticalAlignment="Center">
                                    <FontIcon
                                        Glyph="{x:Bind ViewModel.IsFavorite, Mode=OneWay, Converter={StaticResource FavoriteIconConverter}}"
                                        FontSize="16" Foreground="White" />
                                    <TextBlock Text="Favorite" FontSize="14" Margin="8,0,0,0" Foreground="White" />
                                </StackPanel>
                            </Button>
                            <Button x:Name="WatchedButton"
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Command="{x:Bind ViewModel.ToggleWatchedCommand}"
                                    MinWidth="130"
                                    MinHeight="36"
                                    IsTabStop="True"
                                    IsEnabled="True"
                                    Foreground="White">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center"
                                            VerticalAlignment="Center">
                                    <SymbolIcon Symbol="Accept" Foreground="White" />
                                    <TextBlock Text="{x:Bind ViewModel.WatchedButtonText, Mode=OneWay}" FontSize="14"
                                               Margin="8,0,0,0" Foreground="White" />
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Grid>

            <!-- Cast Section -->
            <Grid Margin="{StaticResource StandardControlMargin}" Padding="40,10,30,40"
                  Visibility="{x:Bind ViewModel.HasCast, Mode=OneWay, Converter={StaticResource BoolToVisibility}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0"
                           FontSize="24"
                           Text="Cast"
                           Margin="{StaticResource StandardControlMargin}"
                           Style="{StaticResource SectionHeaderTextStyle}" />

                <ListView x:Name="CastListView"
                          Grid.Row="1"
                          ItemsSource="{x:Bind ViewModel.Cast, Mode=OneWay}"
                          ScrollViewer.HorizontalScrollMode="Enabled"
                          ScrollViewer.VerticalScrollMode="Disabled"
                          ScrollViewer.HorizontalScrollBarVisibility="Hidden"
                          SelectionMode="None"
                          IsItemClickEnabled="True"
                          ItemClick="OnCastItemClick"
                          TabNavigation="Local"
                          Padding="0,0,14,0"
                          XYFocusUp="{Binding ElementName=PlayButton}">
                    <ListView.ItemsPanel>
                        <ItemsPanelTemplate>
                            <ItemsStackPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ListView.ItemsPanel>
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="Padding" Value="10,10,10,10" />
                            <Setter Property="Margin" Value="0" />
                            <Setter Property="IsTabStop" Value="True" />
                            <Setter Property="IsHitTestVisible" Value="True" />
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <StaticResource ResourceKey="CastMemberTemplate" />
                    </ListView.ItemTemplate>
                </ListView>
            </Grid>

            <!-- Similar Movies -->
            <Grid Margin="{StaticResource HeaderMargin}" Padding="30"
                  Visibility="{x:Bind ViewModel.HasSimilarItems, Mode=OneWay, Converter={StaticResource BoolToVisibility}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0"
                           Text="Similar Movies"
                           FontSize="28"
                           FontWeight="SemiBold"
                           Margin="{StaticResource StandardControlMargin}" />

                <ScrollViewer Grid.Row="1"
                              HorizontalScrollMode="Enabled"
                              VerticalScrollMode="Disabled"
                              HorizontalScrollBarVisibility="Hidden">
                    <GridView ItemsSource="{x:Bind ViewModel.SimilarItems, Mode=OneWay}"
                              SelectionMode="None"
                              IsItemClickEnabled="True"
                              ItemClick="OnSimilarItemClick"
                              ScrollViewer.HorizontalScrollMode="Disabled"
                              ScrollViewer.VerticalScrollMode="Disabled"
                              Padding="0,0,24,0"
                              TabNavigation="Local">
                        <GridView.ItemsPanel>
                            <ItemsPanelTemplate>
                                <ItemsStackPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </GridView.ItemsPanel>
                        <GridView.ItemContainerStyle>
                            <StaticResource ResourceKey="StandardMediaGridViewItemStyle" />
                        </GridView.ItemContainerStyle>
                        <GridView.ItemTemplate>
                            <StaticResource ResourceKey="StandardPosterTemplate" />
                        </GridView.ItemTemplate>
                    </GridView>
                </ScrollViewer>
            </Grid>
        </ListView>

        <!-- Loading State -->
        <controls:LoadingOverlay x:Name="LoadingOverlay"
                                 IsLoading="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                                 LoadingText="Loading movie details..." />
    </Grid>
</views:DetailsPage>
